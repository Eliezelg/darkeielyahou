name: Déploiement automatique sur VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout du code
      uses: actions/checkout@v3

    - name: Déploiement via SSH
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        script: |
          set -e

          echo "🚀 Début du déploiement"
          
          # Aller à la racine du projet
          cd ~/app/darkeielyahou
          
          # Pull du code depuis le repo principal
          echo "📥 Récupération du code..."
          git pull origin main
          
          # Arrêter les anciens processus PM2 s'ils existent
          echo "🛑 Arrêt des anciens processus..."
          pm2 stop darkeielyahou-frontend darkeielyahou-backend 2>/dev/null || true
          pm2 delete darkeielyahou-frontend darkeielyahou-backend 2>/dev/null || true
          
          # Backend
          echo "🚀 Installation backend..."
          cd ~/app/darkeielyahou/backend
          npm install
          npx prisma generate
          
          # Frontend 
          echo "🚀 Installation et build frontend..."
          cd ~/app/darkeielyahou/frontend
          npm install
          echo "🛠️ Build du frontend..."
          npm run build
          
          # Retour à la racine pour PM2
          echo "🚀 Démarrage avec ecosystem.config.js..."
          cd ~/app/darkeielyahou
          
          # Démarrer avec le fichier ecosystem.config.js
          pm2 start ecosystem.config.js --env production
          
          # Sauvegarde de la configuration PM2
          pm2 save
          
          # Afficher le statut
          echo "📊 Statut des processus:"
          pm2 list
          
          echo "✅ Déploiement terminé avec succès"
