name: DÃ©ploiement automatique sur VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout du code
      uses: actions/checkout@v3

    - name: DÃ©ploiement via SSH
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        script: |
          set -e

          echo "ğŸš€ DÃ©but du dÃ©ploiement"
          
          # Aller Ã  la racine du projet
          cd ~/app/darkeielyahou
          
          # Pull du code depuis le repo principal
          echo "ğŸ“¥ RÃ©cupÃ©ration du code..."
          git pull origin main
          
          # ArrÃªter les anciens processus PM2 s'ils existent
          echo "ğŸ›‘ ArrÃªt des anciens processus..."
          pm2 stop darkeielyahou-frontend darkeielyahou-backend 2>/dev/null || true
          pm2 delete darkeielyahou-frontend darkeielyahou-backend 2>/dev/null || true
          
          # Backend
          echo "ğŸš€ Installation backend..."
          cd ~/app/darkeielyahou/backend
          npm install
          npx prisma generate
          
          # Frontend 
          echo "ğŸš€ Installation et build frontend..."
          cd ~/app/darkeielyahou/frontend
          npm install
          echo "ğŸ› ï¸ Build du frontend..."
          npm run build
          
          # Retour Ã  la racine pour PM2
          echo "ğŸš€ DÃ©marrage avec ecosystem.config.js..."
          cd ~/app/darkeielyahou
          
          # DÃ©marrer avec le fichier ecosystem.config.js
          pm2 start ecosystem.config.js --env production
          
          # Sauvegarde de la configuration PM2
          pm2 save
          
          # Afficher le statut
          echo "ğŸ“Š Statut des processus:"
          pm2 list
          
          echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s"
